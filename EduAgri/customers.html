<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customers - EduAgri</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: "Poppins", sans-serif; background:#f9f9f9; color:#333; line-height:1.6; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }
    @keyframes slideDown { from { opacity:0; transform: translateY(-10px); } to { opacity:1; transform: translateY(0); } }

    header { background:#2d6a4f; color:white; padding:15px 40px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; box-shadow:0 4px 12px rgba(0,0,0,0.15); }
    header h1 { margin:0; font-size:1.5rem; }
    nav { display:flex; align-items:center; gap:12px; }
    nav a { color:white; margin-left:8px; text-decoration:none; font-weight:500; transition: all 0.3s ease; }
    nav a:hover { color:#ffb703; transform:scale(1.05); }

    .dropdown { position:relative; }
    .dropdown-content { position:absolute; top:calc(100% + 6px); left:0; background:#fff; color:#333; min-width:200px; border-radius:8px; box-shadow:0 8px 30px rgba(0,0,0,0.12); padding:8px 0; display:none; transform-origin:top center; animation: slideDown 0.18s ease both; }
    .dropdown-content a { display:block; padding:8px 14px; color:#333; text-decoration:none; }
    .dropdown-content a:hover { background:#f1f1f1; color:#ffb703; }
    .dropdown-content.show { display:block; }

    .hero { position: relative; text-align: center; color: white; padding:100px 20px; animation: fadeIn 0.7s ease; }
    .hero img { width: 100%; height: 280px; object-fit: cover; position: absolute; top:0; left:0; z-index:-1; opacity:0.95; }
    section { padding:40px; text-align:center; }
    .card { background:white; padding:20px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); margin-bottom:20px; max-width:900px; margin-left:auto; margin-right:auto; text-align:left; animation:fadeIn 0.5s ease; transition: transform 0.28s ease, box-shadow 0.28s ease; }
    .btn-secondary { background:#219ebc; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; margin-top:10px; text-decoration:none; display:inline-block; transition: all 0.25s ease; }
    .btn-secondary:hover { background:#1b7b93; transform:translateY(-3px); box-shadow:0 8px 20px rgba(33,155,188,0.12); }
    .farmer-list { display:flex; gap:16px; flex-wrap:wrap; }
    .category-filters { text-align:left; margin-bottom:12px; }
    .category-filters button { margin-right:8px; padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; cursor:pointer; }
    .category-filters button.active { background:#2d6a4f; color:#fff; border-color:#2d6a4f; }
    .delete-btn { background:transparent; border:none; color:#c0392b; cursor:pointer; font-size:1rem; margin-left:8px; }
    #customer-orders li { display:flex; justify-content:space-between; align-items:center; padding:6px 0; }
    .farmer { width:280px; border-radius:10px; padding:12px; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.08); }
    .farmer h4 { margin:8px 0; color:#2d6a4f; }
    .product { display:flex; justify-content:space-between; margin:6px 0; }
    .veg-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:16px; margin-top:12px; }
    .veg-card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    .veg-card h4 { color:#2d6a4f; margin-bottom:8px; font-size:1.1rem; }
    .price-info { background:#f0f7f4; padding:10px; border-radius:6px; margin-bottom:10px; }
    .price-info p { margin:4px 0; font-size:0.95rem; }
    .all-bids { background:#fff9f0; padding:10px; border-radius:6px; margin-bottom:10px; border-left:3px solid #ff7f50; }
    .all-bids ul { margin-left:16px; font-size:0.9rem; color:#555; }
    .all-bids li { padding:3px 0; }
    .order-form { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .order-form input { padding:6px 8px; border:1px solid #ddd; border-radius:4px; }
    .order-form select { padding:6px 8px; border:1px solid #ddd; border-radius:4px; cursor:pointer; }
    .order-form button { margin:0; }
    footer { background:#2d6a4f; color:white; text-align:center; padding:30px 20px; margin-top:30px; animation:fadeIn 0.6s ease; }
    .order-confirm { background:#e6ffed; border:1px solid #bdeac8; padding:10px; border-radius:8px; margin-top:10px; }
    /* Toast / non-blocking notification */
    .toast-container { position: fixed; right: 18px; bottom: 18px; display:flex; flex-direction:column; gap:10px; z-index:9999; }
    .toast { background: rgba(0,0,0,0.85); color: #fff; padding:10px 14px; border-radius:8px; min-width:200px; max-width:360px; box-shadow:0 8px 24px rgba(0,0,0,0.28); animation: slideDown 0.18s ease both; }
    .toast .title { font-weight:600; margin-bottom:4px; }
    .toast small { opacity:0.9; font-weight:400; }
  </style>
</head>
<body>

  <header>
    <h1>üåæ EduAgri</h1>
    <nav>
      <a href="index.html">Home</a>
      <div class="dropdown">
        <a href="javascript:void(0)" onclick="toggleDropdown(event)">Category ‚ñº</a>
        <div class="dropdown-content" id="courses-dropdown">
          <a href="soil.html">Soil Science</a>
          <a href="irrigation.html">Irrigation Techniques</a>
          <a href="crop.html">Crop Management</a>
          <a href="smart.html">Smart Farming</a>
          <a href="livestock.html">Livestock</a>
        </div>
      </div>
      <a href="community.html">Community</a>
      <a href="about.html">About</a>
      <a href="farmers.html">Farmers</a>
      <a href="customers.html">Customers</a>
      <a href="login.html">Login</a>
    </nav>
  </header>

  <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <div class="hero" style="background: linear-gradient(rgba(45,106,79,0.7), rgba(45,106,79,0.7)), url('https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=1600&q=80') center/cover no-repeat;">
    <h2>Buy Direct From Farmers</h2>
    <p>Browse local farmers and order fresh produce directly.</p>
  </div>

  <section>
    <div class="card" id="role-check-message" style="display:none; background:#fff3cd; border-left:4px solid #ffc107;">
      <p style="color:#856404; font-weight:600;"></p>
    </div>

    <div id="customer-content">
      <p>Browse vegetables with live bids from local farmers. See average prices and all farmer bids!</p>
      <div id="veg-shop-container">Loading vegetables...</div>
    </div>

    <div class="card">
      <h3>Your Orders üì¶</h3>
      <ul id="customer-orders"></ul>
    </div>
    </div>
  </section>

  <footer>
    <p>¬© 2025 EduAgri. All Rights Reserved.</p>
  </footer>

  <script>
    // Initialize vegetables
    function initializeVegetables() {
      if (!localStorage.getItem('availableVegetables')) {
        const vegetables = [
          { id: 'v1', name: 'Tomato', unit: 'kg' },
          { id: 'v2', name: 'Potato', unit: 'kg' },
          { id: 'v3', name: 'Onion', unit: 'kg' },
          { id: 'v4', name: 'Carrot', unit: 'kg' },
          { id: 'v5', name: 'Broccoli', unit: 'kg' }
        ];
        localStorage.setItem('availableVegetables', JSON.stringify(vegetables));
      }
    }

    // Get average price per vegetable
    function getAveragePricePerVegetable() {
      const allBids = JSON.parse(localStorage.getItem('farmerBids')) || [];
      const vegetables = JSON.parse(localStorage.getItem('availableVegetables')) || [];

      const avgPricesPerVeg = {};

      vegetables.forEach(veg => {
        const bidsForVeg = allBids.filter(bid => 
          bid.vegetableId === veg.id && 
          bid.quantityRemaining > 0
        );

        if (bidsForVeg.length > 0) {
          const totalPrice = bidsForVeg.reduce((sum, bid) => sum + bid.pricePerKg, 0);
          const avgPrice = (totalPrice / bidsForVeg.length).toFixed(2);

          avgPricesPerVeg[veg.id] = {
            vegetable: veg,
            averagePrice: avgPrice,
            farmerCount: bidsForVeg.length,
            allBids: bidsForVeg,
            totalAvailable: bidsForVeg.reduce((sum, bid) => sum + bid.quantityRemaining, 0)
          };
        }
      });

      return avgPricesPerVeg;
    }

    // Display vegetables with average prices
    function displayVegetableShop() {
      const avgPrices = getAveragePricePerVegetable();
      let html = '';
      
      const vegData = Object.values(avgPrices);
      if (vegData.length === 0) {
        html = '<p style="color:#999; text-align:center; padding:40px;">No vegetables available with active farmer bids. Farmers need to create bids first!</p>';
      } else {
        html = '<div class="veg-grid">';
        vegData.forEach(data => {
          const veg = data.vegetable;
          const avgPrice = data.averagePrice;
          const farmerCount = data.farmerCount;
          const allBids = data.allBids;
          const totalAvailable = data.totalAvailable;

          html += `
            <div class="veg-card">
              <h4>ü•ï ${veg.name}</h4>
              
              <div class="price-info">
                <p><strong>Average Price:</strong> ‚Çπ${avgPrice}/${veg.unit}</p>
                <p><strong>Farmers Selling:</strong> ${farmerCount}</p>
                <p><strong>Total Available:</strong> ${totalAvailable}${veg.unit}</p>
              </div>

              <div class="all-bids">
                <strong>All Farmer Bids:</strong>
                <ul>
                  ${allBids.map(bid => 
                    `<li>‚Çπ${bid.pricePerKg}/${veg.unit} by <strong>${bid.farmerName}</strong> (${bid.quantityRemaining}${veg.unit})</li>`
                  ).join('')}
                </ul>
              </div>

              <form class="order-form" onsubmit="orderFromBid(event)">
                <input type="number" name="qty" min="0.1" step="0.1" max="${totalAvailable}" 
                       placeholder="Qty (${veg.unit})" required>
                <select name="selectedBidId" required>
                  <option value="">-- Select Farmer --</option>
                  ${allBids.map(bid => 
                    `<option value="${bid.bidId}">‚Çπ${bid.pricePerKg} - ${bid.farmerName}</option>`
                  ).join('')}
                </select>
                <button type="submit" class="btn-secondary">Order</button>
              </form>
            </div>
          `;
        });
        html += '</div>';
      }

      document.getElementById('veg-shop-container').innerHTML = html;
    }

    // Place order from bid
    function orderFromBid(event) {
      event.preventDefault();

      const customerId = localStorage.getItem('currentUser');
      if (!customerId) {
        showToast('Please log in first!');
        return;
      }

      const quantity = parseFloat(event.target.qty.value);
      const selectedBidId = event.target.selectedBidId.value;

      let bids = JSON.parse(localStorage.getItem('farmerBids')) || [];
      const bid = bids.find(b => b.bidId === selectedBidId);

      if (!bid || bid.quantityRemaining < quantity) {
        showToast('Not enough quantity available!', 4500);
        return;
      }

      // Create order
      const newOrder = {
        orderId: 'order_' + Date.now(),
        customerId: customerId,
        bidId: bid.bidId,
        farmerId: bid.farmerId,
        farmerName: bid.farmerName,
        vegetableId: bid.vegetableId,
        vegetableName: bid.vegetableName,
        quantity: quantity,
        pricePerKg: bid.pricePerKg,
        totalPrice: (quantity * bid.pricePerKg).toFixed(2)
      };

      // Update bid: reduce remaining quantity
      bid.quantityRemaining -= quantity;

      // Store order and update bid
      let orders = JSON.parse(localStorage.getItem('customerOrdersFromBids')) || [];
      orders.push(newOrder);
      localStorage.setItem('customerOrdersFromBids', JSON.stringify(orders));
      localStorage.setItem('farmerBids', JSON.stringify(bids));

      showToast(`Order placed! ${newOrder.quantity}kg ${newOrder.vegetableName} for ‚Çπ${newOrder.totalPrice} ‚úÖ`, 4500);
      displayVegetableShop();
      displayCustomerOrders();
    }

    // Display customer's orders
    function displayCustomerOrders() {
      const customerId = localStorage.getItem('currentUser');
      const allOrders = JSON.parse(localStorage.getItem('customerOrdersFromBids')) || [];
      const myOrders = allOrders.filter(o => o.customerId === customerId);

      const ordersEl = document.getElementById('customer-orders');
      ordersEl.innerHTML = '';

      if (myOrders.length === 0) {
        ordersEl.innerHTML = '<li style="color:#999;">No orders yet. Browse vegetables above!</li>';
      } else {
        myOrders.forEach(order => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div>
              <strong>${order.vegetableName}</strong> - ${order.quantity}kg @ ‚Çπ${order.pricePerKg}/kg = <strong>‚Çπ${order.totalPrice}</strong>
              <br><small style="color:#666;">From: ${order.farmerName}</small>
            </div>
          `;
          ordersEl.appendChild(li);
        });
      }
    }

    // Load on page load
    window.addEventListener('load', function() {
      const userRole = localStorage.getItem('userRole') || 'customer';
      const customerContent = document.getElementById('customer-content');
      const roleCheckMessage = document.getElementById('role-check-message');

      if (userRole !== 'customer') {
        // User is not a customer
        roleCheckMessage.style.display = 'block';
        roleCheckMessage.querySelector('p').textContent = '‚ö†Ô∏è This page is for customers only. Please login with your customer account to browse and order vegetables.';
        customerContent.style.display = 'none';
      } else {
        // User is a customer
        roleCheckMessage.style.display = 'none';
        customerContent.style.display = 'block';
        initializeVegetables();
        displayVegetableShop();
        displayCustomerOrders();
      }
    });
  </script>
  <script>
    // Non-blocking toast notifications to replace alert()
    function showToast(message, duration) {
      duration = duration || 4500;
      var container = document.getElementById('toast-container');
      if (!container) return console.log(message);
      var t = document.createElement('div');
      t.className = 'toast';
      // preserve simple newlines
      t.innerHTML = message.split('\n').map(function(line){ return '<div>' + line + '</div>'; }).join('');
      container.appendChild(t);
      setTimeout(function(){ t.style.opacity = '0'; t.style.transform = 'translateY(6px)'; }, duration - 300);
      setTimeout(function(){ try{ container.removeChild(t); }catch(e){} }, duration);
    }
  </script>
  <script>
    function toggleDropdown(event) {
      event.preventDefault();
      const dropdown = document.getElementById('courses-dropdown');
      dropdown.classList.toggle('show');
    }
    document.addEventListener('click', function(event) {
      const dropdown = document.querySelector('.dropdown');
      if (dropdown && !dropdown.contains(event.target)) {
        document.getElementById('courses-dropdown').classList.remove('show');
      }
    });
  </script>

</body>
</html>
